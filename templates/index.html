<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <link
            href="https://fonts.googleapis.com/icon?family=Material+Icons"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap"
            rel="stylesheet"
        />

        <style>
            html,
            body {
                height: 100%;
                margin: 0;
                background-color: #282828;
                cursor: auto;
            }

            /* Card Style */
            .card {
                border-radius: 20px;
                box-shadow: 0px 2px 0px 0px;
                box-sizing: border-box;
            }

            /* Text Style */
            .text {
                font-family: "Space Grotesk", sans-serif;
                font-weight: 400;
                font-size: 16px;
                color: white;
                margin: 0;
                white-space: normal;
                word-break: break-word;
            }

            /* Title Style */
            .title {
                font-family: "Space Grotesk", sans-serif;
                font-weight: 800;
                font-size: 24px;
                color: #83a598;
                margin: auto;
            }

            /* Button Style */
            .button {
                height: 64px;
                background: #1d2021;
                border: 1px solid #83a598;
                border-radius: 20px;
                box-shadow: 0px 4px 0px 0px;
                position: relative;
                cursor: pointer;
                top: 0px;
                transition:
                    height 90ms ease,
                    box-shadow 90ms ease,
                    top 90ms ease;
            }
            .button:active {
                height: 64px;
                box-shadow: 0px 0px 0px 0px;
                top: 4px;
            }
        </style>
    </head>

    <body>
        <div
            id="main"
            style="
                max-width: 900px;
                width: 100%;
                height: 100vh;
                margin: auto;
                display: flex;
                flex-direction: column;
                padding: 40px 0;
                box-sizing: border-box;
                gap: 40px;
            "
        >
            <div
                id="header"
                style="
                    width: 100%;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                "
            >
                <div
                    style="height: 1px; background: #83a598; width: 100%"
                ></div>
                <p class="title">SMITHY</p>
                <div
                    style="height: 1px; background: #83a598; width: 100%"
                ></div>
            </div>

            <!-- smithy: flexible area -->
            <div
                id="smithy"
                style="
                    width: 100%;
                    flex: 1 1 auto;
                    display: flex;
                    flex-direction: column;
                    align-items: stretch;
                    justify-content: flex-start;
                    padding: 0 0 8px 0;
                    margin: 0;
                    gap: 10px;
                    min-height: 0;
                    overflow: auto;
                    box-sizing: border-box;
                "
            >
                <div
                    id="empty-state"
                    style="text-align: center; align-self: center"
                >
                    <p class="title" style="color: #83a598; opacity: 0.5">
                        ...
                    </p>
                </div>
            </div>

            <!-- buttons: hidden until command present -->
            <div
                id="buttons-container"
                style="
                    display: none;
                    gap: 5px;
                    height: 64px;
                    align-items: center;
                    box-sizing: border-box;
                    flex-shrink: 0;
                "
            >
                <button
                    onclick="handleDeny()"
                    class="button"
                    style="
                        width: 128px;
                        border-color: #fe8019;
                        box-shadow: #fe8019;
                        border-radius: 20px 0 0 20px;
                        flex: 0 0 128px;
                    "
                >
                    <p class="text" style="font-size: 16px">Deny</p>
                </button>
                <button
                    onclick="handleConfirm()"
                    class="button"
                    style="
                        flex: 1 1 auto;
                        border-radius: 0 20px 20px 0;
                        min-width: 0;
                    "
                >
                    <p class="text" style="font-size: 16px">Confirm</p>
                </button>
            </div>

            <!-- bottom bar: prompt + send -->
            <div
                id="bottom_bar"
                style="
                    width: 100%;
                    height: 64px;
                    display: flex;
                    flex-direction: row;
                    padding: 0;
                    justify-content: flex-end;
                    gap: 5px;
                    align-items: center;
                    box-sizing: border-box;
                    flex-shrink: 0;
                "
            >
                <div
                    id="prompt_box"
                    class="card"
                    style="
                        flex: 1 1 auto;
                        min-width: 0;
                        height: 64px;
                        margin: 0;
                        display: flex;
                        align-items: center;
                        padding: 12px 18px;
                        background-color: #3c3836;
                        border-radius: 20px 0 0 20px;
                        box-sizing: border-box;
                    "
                >
                    <input
                        type="text"
                        id="user_input"
                        onkeydown="if(event.key==='Enter') send()"
                        placeholder="Enter your message..."
                        style="
                            width: 100%;
                            min-width: 0;
                            background: transparent;
                            border: none;
                            outline: none;
                            color: white;
                            font-family: &quot;Space Grotesk&quot;, sans-serif;
                            font-size: 16px;
                            overflow-wrap: anywhere;
                        "
                    />
                </div>

                <button
                    onclick="send()"
                    class="button"
                    style="
                        width: 64px;
                        height: 64px;
                        background: #282828;
                        margin: 0 0 2px 0;
                        border-radius: 0 20px 20px 0;
                        flex: 0 0 64px;
                        box-sizing: border-box;
                    "
                >
                    <span class="material-icons" style="color: white"
                        >send</span
                    >
                </button>
            </div>
        </div>

        <script>
            function handleConfirm() {
                fetch("/confirm", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: "confirm" }),
                })
                    .then((res) => {
                        if (res.status === 404) {
                            updateSmithyCards({
                                Message:
                                    "Command confirmed! (Server endpoint not implemented yet)",
                                Command: null,
                            });
                            return;
                        }
                        return res.text();
                    })
                    .then((text) => {
                        if (!text) return;
                        try {
                            const data = JSON.parse(text);
                            updateSmithyCards(data);
                        } catch (e) {
                            console.error(
                                "Failed to parse confirm response",
                                e,
                            );
                        }
                    })
                    .catch((e) => {
                        console.error("Confirm fetch error", e);
                        updateSmithyCards({
                            Message: "Error connecting to server for confirm",
                            Command: null,
                        });
                    });
            }

            function handleDeny() {
                fetch("/deny", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: "deny" }),
                })
                    .then((res) => {
                        if (res.status === 404) {
                            updateSmithyCards({
                                Message:
                                    "Command denied! (Server endpoint not implemented yet)",
                                Command: null,
                            });
                            return;
                        }
                        return res.text();
                    })
                    .then((text) => {
                        if (!text) return;
                        try {
                            const data = JSON.parse(text);
                            updateSmithyCards(data);
                        } catch (e) {
                            console.error("Failed to parse deny response", e);
                        }
                    })
                    .catch((e) => {
                        console.error("Deny fetch error", e);
                        updateSmithyCards({
                            Message: "Error connecting to server for deny",
                            Command: null,
                        });
                    });
            }

            function send() {
                const userInputEl = document.getElementById("user_input");
                const userInput = userInputEl.value || "";

                fetch("/run", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_input: userInput }),
                })
                    .then((res) => {
                        if (res.status === 404) {
                            const exampleData = {
                                Message: userInput || "No input provided",
                                Command: {
                                    Command: "email",
                                    Action: "send",
                                    To: ["bob@gmail.com"],
                                    Subject: "Test Subject",
                                    Body: `User input: ${userInput}`,
                                },
                            };
                            updateSmithyCards(exampleData);
                            userInputEl.value = "";
                            return;
                        }
                        return res.text();
                    })
                    .then((text) => {
                        if (!text) return;
                        try {
                            const data = JSON.parse(text);
                            updateSmithyCards(data);
                            document.getElementById("user_input").value = "";
                        } catch (e) {
                            console.error("Failed to parse send response", e);
                            console.log("Raw response:", text);
                        }
                    })
                    .catch((e) => {
                        console.error("Send fetch error", e);
                        updateSmithyCards({
                            Message: "Error connecting to server",
                            Command: null,
                        });
                        document.getElementById("user_input").value = "";
                    });
            }

            function updateSmithyCards(data) {
                const smithyContainer = document.getElementById("smithy");
                if (!smithyContainer) return;

                // clear and reset
                smithyContainer.innerHTML = "";
                smithyContainer.style.justifyContent = "flex-start";
                smithyContainer.style.minHeight = "0";

                let hasContent = false;

                // create containers (always present so layout predictable)
                const messageDiv = document.createElement("div");
                messageDiv.style.display = "flex";
                messageDiv.style.flexDirection = "column";
                messageDiv.style.gap = "0px";
                messageDiv.style.minHeight = "0";
                messageDiv.style.boxSizing = "border-box";
                smithyContainer.appendChild(messageDiv);

                const commandDiv = document.createElement("div");
                commandDiv.style.display = "flex";
                commandDiv.style.flexDirection = "column";
                commandDiv.style.gap = "5px";
                commandDiv.style.minHeight = "0";
                commandDiv.style.boxSizing = "border-box";
                smithyContainer.appendChild(commandDiv);

                // message card
                const messageText = data && (data.Message || data.message);
                if (messageText) {
                    const messageCard = document.createElement("div");
                    messageCard.className = "card";
                    messageCard.style.cssText = `
            background-color: #1d2021;
            padding: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            min-height: 0;
            box-sizing: border-box;
          `;
                    const messageTextEl = document.createElement("p");
                    messageTextEl.className = "text";
                    messageTextEl.textContent = messageText;
                    messageCard.appendChild(messageTextEl);
                    messageDiv.appendChild(messageCard);
                    hasContent = true;
                }

                // command cards
                const commandData = data && (data.Command || data.command);
                if (commandData && typeof commandData === "object") {
                    const commandKeys = Object.keys(commandData).filter(
                        (k) =>
                            k.toLowerCase() !== "command" &&
                            k.toLowerCase() !== "action",
                    );

                    // action card
                    const actionCard = document.createElement("div");
                    actionCard.className = "card";
                    const actionBorderRadius =
                        commandKeys.length === 0 ? "20px" : "20px 20px 5px 5px";
                    actionCard.style.cssText = `
            background-color: #1d2021;
            padding: 20px;
            flex-shrink: 0;
            border-radius: ${actionBorderRadius};
            display: flex;
            flex-direction: column;
            min-height: 0;
            box-sizing: border-box;
          `;
                    const actionText = document.createElement("p");
                    actionText.className = "text";
                    const commandName =
                        commandData.Command || commandData.command || "Unknown";
                    const actionName =
                        commandData.Action || commandData.action || "Unknown";
                    actionText.textContent = `${actionName.charAt(0).toUpperCase() + actionName.slice(1)} ${commandName.charAt(0).toUpperCase() + commandName.slice(1)}`;
                    actionCard.appendChild(actionText);
                    commandDiv.appendChild(actionCard);

                    // property cards
                    commandKeys.forEach((key, index) => {
                        const card = document.createElement("div");
                        card.className = "card";
                        const borderRadius =
                            index === commandKeys.length - 1
                                ? "5px 5px 20px 20px"
                                : "5px";
                        card.style.cssText = `
              background-color: #1d2021;
              padding: 20px;
              flex-shrink: 0;
              border-radius: ${borderRadius};
              display: flex;
              flex-direction: column;
              min-height: 0;
              box-sizing: border-box;
            `;
                        const text = document.createElement("p");
                        text.className = "text";
                        let value = commandData[key];
                        if (Array.isArray(value)) value = value.join(", ");
                        text.textContent = `${key}: ${value}`;
                        card.appendChild(text);
                        commandDiv.appendChild(card);
                    });

                    hasContent = true;
                }

                // find last non-empty container (either messageDiv or commandDiv)
                if (hasContent) {
                    const children = Array.from(smithyContainer.children);
                    let lastContainer = null;
                    for (let i = children.length - 1; i >= 0; i--) {
                        if (
                            children[i].children &&
                            children[i].children.length > 0
                        ) {
                            lastContainer = children[i];
                            break;
                        }
                    }

                    if (lastContainer) {
                        lastContainer.style.display = "flex";
                        lastContainer.style.flexDirection = "column";
                        lastContainer.style.flex = "1 1 auto"; // take remaining space
                        lastContainer.style.minHeight = "0";
                        lastContainer.style.overflow = "hidden";
                        lastContainer.style.boxSizing = "border-box";
                        lastCard.style.marginBottom = "2px";

                        const lastCard =
                            lastContainer.children[
                                lastContainer.children.length - 1
                            ];
                        if (lastCard) {
                            lastCard.style.display = "flex";
                            lastCard.style.flexDirection = "column";
                            lastCard.style.flex = "1 1 auto";
                            lastCard.style.minHeight = "0";
                            lastCard.style.maxHeight = "100%";
                            lastCard.style.overflow = "auto";
                            lastCard.style.boxSizing = "border-box";
                        }
                    }
                }

                // show/hide buttons
                const buttonsContainer =
                    document.getElementById("buttons-container");
                const hasCommand =
                    commandData && Object.keys(commandData).length > 0;
                buttonsContainer.style.display = hasCommand ? "flex" : "none";

                // if no content, show empty state
                if (!hasContent) {
                    smithyContainer.style.justifyContent = "center";
                    smithyContainer.innerHTML = `
            <div id="empty-state" style="text-align:center; align-self:center;">
              <p class="title" style="color:#83a598; opacity:0.5">Ready</p>
            </div>
          `;
                }
            }
        </script>
    </body>
</html>
